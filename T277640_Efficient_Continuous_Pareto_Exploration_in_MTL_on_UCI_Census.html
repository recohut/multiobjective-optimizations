
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Efficient Continuous Pareto Exploration in MTL on UCI Census &#8212; multiobjective-optimizations</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Multi-Task Learning" href="T851476_Multi_Task_Learning.html" />
    <link rel="prev" title="Solving MOO with SMT Toolkit" href="T423887_Solving_MOO_with_SMT_Toolkit.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">multiobjective-optimizations</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L069335_Multi_Objective_Optimization.html">
   Multi-Objective Optimization
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Concepts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L492548_Efficient_Frontier.html">
   Efficient Frontier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L839342_Pareto_Optimality.html">
   Pareto Optimality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L483593_MOO_Decision_Maker.html">
   MOO Decision Maker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L336869_Multi_Task_Learning.html">
   Multi-Task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L553498_MOO_in_Recommender_Systems.html">
   MOO in Recommender Systems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L480379_Marketplace_Recommenders.html">
   Marketplace Recommenders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L556513_Multi_Objective_Hyperparameter_Optimization.html">
   Multi-Objective Hyperparameter Optimization
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Methods
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L005003_Scalarization.html">
   Scalarization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L762719_Shared_Bottom.html">
   Shared Bottom
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L915313_Expected_Hypervolume_Improvement_%28EHVI%29.html">
   Expected Hypervolume Improvement (EHVI)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L587138_Multi_gradient_Descent_%28MGDRec%29.html">
   Multi-gradient Descent (MGDRec)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L861465_Mixture_of_Experts_%28MoE%29.html">
   Mixture of Experts (MoE)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L485744_Multi_gate_Mixture_of_Experts_%28MMoE%29.html">
   Multi-gate Mixture-of-Experts (MMoE)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L519476_Entire_Space_Multi_Task_Model_%28ESSM%29.html">
   Entire Space Multi-Task Model (ESSM)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L718205_Progressive_Layered_Extraction_%28PLE%29.html">
   Progressive Layered Extraction (PLE)
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Cases
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="L749932_MTL_for_Related_Products_Recommendations_at_Pinterest.html">
   MTL for Related Products Recommendations at Pinterest
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L792752_UberEats.html">
   UberEats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L106645_Etsy.html">
   Etsy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="L149938_Airbnb_Experiences.html">
   Airbnb Experiences
  </a>
 </li>
</ul>
<p class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="T929652_Efficient_Frontier.html">
   Efficient Frontier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T854417_Linear_Optimization_with_OR_Tools.html">
   Linear Optimization with OR-Tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T209908_Stein%27s_Paradox.html">
   Stein’s Paradox
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T423887_Solving_MOO_with_SMT_Toolkit.html">
   Solving MOO with SMT Toolkit
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Efficient Continuous Pareto Exploration in MTL on UCI Census
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T851476_Multi_Task_Learning.html">
   Multi-Task Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T307666_Pareto_Efficient_algorithm_for_MOO.html">
   Pareto-Efficient algorithm for MOO
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T465017_Shared_Bottom_in_Tensorflow.html">
   Shared Bottom in Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T175823_MoE_in_Tensorflow.html">
   MoE in Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T580632_MMoE_on_Census_income_data_in_Tensorflow.html">
   MMoE on Census income data in Tensorflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T948705_Sparsely_gated_Mixture_of_Experts.html">
   Sparsely-gated Mixture-of-Experts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T458949_Multi_Objective_Ranking_using_Constrained_Optimization_in_GBTs.html">
   Multi-Objective Ranking using Constrained Optimization in GBTs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T145475_Multi_objective_Optimization_using_Pymoo_Library.html">
   Multi-objective Optimization using Pymoo Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T892775_Exploring_Multi_Objective_Hyperparameter_Optimization.html">
   Exploring Multi-Objective Hyperparameter Optimization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T660394_Implicit_Hybrid_Movie_Recommender_using_Collie_Library.html">
   Implicit Hybrid Movie Recommender using Collie Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T559084_Multi_task_Learning_on_ML_100k_in_TFRS.html">
   Multi-task Learning on ML-100k in TFRS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T368830_Multi_Task_Recommender_on_Olist_dataset_using_TFRS_Library.html">
   Multi-Task Recommender on Olist dataset using TFRS Library
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T671443_MAMO_Framework.html">
   MAMO Framework
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="T952247_MKR.html">
   MKR
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/sparsh-ai/multiobjective-optimizations/main?urlpath=tree/docs/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/sparsh-ai/multiobjective-optimizations/blob/main/docs/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#min-norm-solver">
   <code class="docutils literal notranslate">
    <span class="pre">
     min_norm_solver
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#random-seed-fixation">
   Random seed fixation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset-definition">
   Dataset definition
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataset-preparation">
   Dataset Preparation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pytorch-initialization">
   PyTorch initialization
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#checkpoint-paths">
     Checkpoint paths
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#device-initialization">
     Device initialization
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#training-and-test-dataloader">
     Training and test dataloader
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#utility-functions">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#empirical-pareto-front-generation">
   Empirical Pareto front generation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sgd-preparation">
   SGD preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hyper-parameters-declaration">
     Hyper-Parameters declaration
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#network-definition">
     Network definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loss-function-definition">
     Loss function definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#optimizer-definition">
     Optimizer definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#learning-rate-scheduler-definition">
     Learning rate scheduler definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#snapshot-for-inital-states">
     Snapshot for inital states
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#let-s-train-it">
   Let’s train it!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sgd-results-illustration">
   SGD results illustration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#minres-based-pareto-exploration">
   MINRES-based Pareto exploration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#minres-preparation">
   MINRES preparation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Hyper-Parameters declaration
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dataloader-definition">
     Dataloader definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Optimizer definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#jacobians-solver-definition">
     Jacobians solver definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#alpha-solver-definition">
     Alpha solver definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#linear-operator-for-hessian-vector-product-definition">
     Linear operator for Hessian-vector product definition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Utility functions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#let-s-explore-it">
   Let’s explore it!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#minres-results-illustration">
   MINRES results illustration
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="efficient-continuous-pareto-exploration-in-mtl-on-uci-census">
<h1>Efficient Continuous Pareto Exploration in MTL on UCI Census<a class="headerlink" href="#efficient-continuous-pareto-exploration-in-mtl-on-uci-census" title="Permalink to this headline">¶</a></h1>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">LinearOperator</span><span class="p">,</span> <span class="n">minres</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.legend_handler</span> <span class="kn">import</span> <span class="n">HandlerTuple</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">torch.optim.lr_scheduler</span> <span class="kn">import</span> <span class="n">CosineAnnealingLR</span>
<span class="kn">from</span> <span class="nn">torch.nn.utils</span> <span class="kn">import</span> <span class="n">parameters_to_vector</span><span class="p">,</span> <span class="n">vector_to_parameters</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="min-norm-solver">
<h2><code class="docutils literal notranslate"><span class="pre">min_norm_solver</span></code><a class="headerlink" href="#min-norm-solver" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_min_norm_element_from2</span><span class="p">(</span><span class="n">v1v1</span><span class="p">,</span> <span class="n">v1v2</span><span class="p">,</span> <span class="n">v2v2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analytical solution for min_{c} |cx_1 + (1-c)x_2|_2^2</span>
<span class="sd">    d is the distance (objective) optimzed</span>
<span class="sd">    v1v1 = &lt;x1,x1&gt;</span>
<span class="sd">    v1v2 = &lt;x1,x2&gt;</span>
<span class="sd">    v2v2 = &lt;x2,x2&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">v1v2</span> <span class="o">&gt;=</span> <span class="n">v1v1</span><span class="p">:</span>
        <span class="c1"># Case: Fig 1, third column</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.999</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">v1v1</span>
        <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">cost</span>
    <span class="k">if</span> <span class="n">v1v2</span> <span class="o">&gt;=</span> <span class="n">v2v2</span><span class="p">:</span>
        <span class="c1"># Case: Fig 1, first column</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.001</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="n">v2v2</span>
        <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">cost</span>
    <span class="c1"># Case: Fig 1, second column</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="n">v2v2</span> <span class="o">-</span> <span class="n">v1v2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">v1v1</span> <span class="o">+</span> <span class="n">v2v2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v1v2</span><span class="p">)</span>
    <span class="c1"># v2v2 - gamm * gamma * (v1 - v2)^2</span>
    <span class="c1"># cost = v2v2 - gamma * gamma * (v1v1 + v2v2 - 2 * v1v2)</span>
    <span class="c1">#      = v2v2 - gamma * (v2v2 - v1v2)</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">v2v2</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1v2</span> <span class="o">-</span> <span class="n">v2v2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">cost</span>


<span class="k">def</span> <span class="nf">_min_norm_2d</span><span class="p">(</span><span class="n">vecs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the minimum norm solution as combination of two points</span>
<span class="sd">    This is correct only in 2D</span>
<span class="sd">    ie. min_c |\sum c_i x_i|_2^2 st. \sum c_i = 1 , 1 &gt;= c_1 &gt;= 0 for all i, c_i + c_j = 1.0 for some i, j</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dmin</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dps</span> <span class="o">=</span> <span class="n">vecs</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vecs</span><span class="p">)),</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">_min_norm_element_from2</span><span class="p">(</span><span class="n">dps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">dps</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">dmin</span><span class="p">:</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="n">d</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">sol</span><span class="p">,</span> <span class="n">dps</span>


<span class="k">def</span> <span class="nf">_projection2simplex</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given y, it solves argmin_z |y-z|_2 st \sum z = 1 , 1 &gt;= z_i &gt;= 0 for all i</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">sorted_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tmpsum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">tmax_f</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">tmpsum</span> <span class="o">+=</span> <span class="n">sorted_y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmpsum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmax</span> <span class="o">&gt;</span> <span class="n">sorted_y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">tmax_f</span> <span class="o">=</span> <span class="n">tmax</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">tmax_f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_next_point</span><span class="p">(</span><span class="n">cur_val</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">proj_grad</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">tm1</span> <span class="o">=</span> <span class="o">-</span><span class="n">cur_val</span><span class="p">[</span><span class="n">proj_grad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">proj_grad</span><span class="p">[</span><span class="n">proj_grad</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">tm2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cur_val</span><span class="p">[</span><span class="n">proj_grad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">proj_grad</span><span class="p">[</span><span class="n">proj_grad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tm1</span><span class="p">[</span><span class="n">tm1</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tm1</span><span class="p">[</span><span class="n">tm1</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tm2</span><span class="p">[</span><span class="n">tm2</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tm2</span><span class="p">[</span><span class="n">tm2</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">]))</span>

    <span class="n">next_point</span> <span class="o">=</span> <span class="n">proj_grad</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">cur_val</span>
    <span class="n">next_point</span> <span class="o">=</span> <span class="n">_projection2simplex</span><span class="p">(</span><span class="n">next_point</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">next_point</span>


<span class="k">def</span> <span class="nf">find_min_norm_element</span><span class="p">(</span><span class="n">vecs</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">stop_crit</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of vectors (vecs), this method finds the minimum norm element in the convex hull</span>
<span class="sd">    as min |u|_2 st. u = \sum c_i vecs[i] and \sum c_i = 1.</span>
<span class="sd">    It is quite geometric, and the main idea is the fact that if d_{ij} = min |u|_2 st u = c x_i + (1-c) x_j;</span>
<span class="sd">    the solution lies in (0, d_{i,j})</span>
<span class="sd">    Hence, we find the best 2-task solution, and then run the projected gradient descent until convergence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Solution lying at the combination of two points</span>
    <span class="n">init_sol</span><span class="p">,</span> <span class="n">dps</span> <span class="o">=</span> <span class="n">_min_norm_2d</span><span class="p">(</span><span class="n">vecs</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vecs</span><span class="p">)</span>
    <span class="n">sol_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">sol_vec</span><span class="p">[</span><span class="n">init_sol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">init_sol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">sol_vec</span><span class="p">[</span><span class="n">init_sol</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">init_sol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># This is optimal for n=2, so return the solution</span>
        <span class="k">return</span> <span class="n">sol_vec</span><span class="p">,</span> <span class="n">init_sol</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">iter_count</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="n">grad_dir</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dps</span><span class="p">,</span> <span class="n">sol_vec</span><span class="p">)</span>
        <span class="n">new_point</span> <span class="o">=</span> <span class="n">_next_point</span><span class="p">(</span><span class="n">sol_vec</span><span class="p">,</span> <span class="n">grad_dir</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="c1"># Re-compute the inner products for line search</span>
        <span class="n">v1v1</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">v1v2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">v2v2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">v1v1</span> <span class="o">+=</span> <span class="n">sol_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sol_vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">dps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">v1v2</span> <span class="o">+=</span> <span class="n">sol_vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_point</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">dps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">v2v2</span> <span class="o">+=</span> <span class="n">new_point</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">new_point</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">dps</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">nc</span><span class="p">,</span> <span class="n">nd</span> <span class="o">=</span> <span class="n">_min_norm_element_from2</span><span class="p">(</span><span class="n">v1v1</span><span class="p">,</span> <span class="n">v1v2</span><span class="p">,</span> <span class="n">v2v2</span><span class="p">)</span>
        <span class="n">new_sol_vec</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">*</span> <span class="n">sol_vec</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">nc</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_point</span>
        <span class="n">change</span> <span class="o">=</span> <span class="n">new_sol_vec</span> <span class="o">-</span> <span class="n">sol_vec</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">change</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">stop_crit</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">sol_vec</span> <span class="o">=</span> <span class="n">new_sol_vec</span>
    <span class="k">return</span> <span class="n">sol_vec</span><span class="p">,</span> <span class="n">nd</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="random-seed-fixation">
<h2>Random seed fixation<a class="headerlink" href="#random-seed-fixation" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">manual_seed_all</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-definition">
<h2>Dataset definition<a class="headerlink" href="#dataset-definition" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uci_info</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">age: label.</span>
<span class="s1">class of worker: Not in universe, Federal government, Local government, Never worked, Private, Self-employed-incorporated, Self-employed-not incorporated, State government, Without pay.</span>
<span class="s1">detailed industry recode: 0, 40, 44, 2, 43, 47, 48, 1, 11, 19, 24, 25, 32, 33, 34, 35, 36, 37, 38, 39, 4, 42, 45, 5, 15, 16, 22, 29, 31, 50, 14, 17, 18, 28, 3, 30, 41, 46, 51, 12, 13, 21, 23, 26, 6, 7, 9, 49, 27, 8, 10, 20.</span>
<span class="s1">detailed occupation recode: 0, 12, 31, 44, 19, 32, 10, 23, 26, 28, 29, 42, 40, 34, 14, 36, 38, 2, 20, 25, 37, 41, 27, 24, 30, 43, 33, 16, 45, 17, 35, 22, 18, 39, 3, 15, 13, 46, 8, 21, 9, 4, 6, 5, 1, 11, 7.</span>
<span class="s1">education: label.</span>
<span class="s1">wage per hour: continuous.</span>
<span class="s1">enroll in edu inst last wk: Not in universe, High school, College or university.</span>
<span class="s1">marital stat: label.</span>
<span class="s1">major industry code: Not in universe or children, Entertainment, Social services, Agriculture, Education, Public administration, Manufacturing-durable goods, Manufacturing-nondurable goods, Wholesale trade, Retail trade, Finance insurance and real estate, Private household services, Business and repair services, Personal services except private HH, Construction, Medical except hospital, Other professional services, Transportation, Utilities and sanitary services, Mining, Communications, Hospital services, Forestry and fisheries, Armed Forces.</span>
<span class="s1">major occupation code: Not in universe, Professional specialty, Other service, Farming forestry and fishing, Sales, Adm support including clerical, Protective services, Handlers equip cleaners etc , Precision production craft &amp; repair, Technicians and related support, Machine operators assmblrs &amp; inspctrs, Transportation and material moving, Executive admin and managerial, Private household services, Armed Forces.</span>
<span class="s1">race: White, Black, Other, Amer Indian Aleut or Eskimo, Asian or Pacific Islander.</span>
<span class="s1">hispanic origin: Mexican (Mexicano), Mexican-American, Puerto Rican, Central or South American, All other, Other Spanish, Chicano, Cuban, Do not know, NA.</span>
<span class="s1">sex: Female, Male.</span>
<span class="s1">member of a labor union: Not in universe, No, Yes.</span>
<span class="s1">reason for unemployment: Not in universe, Re-entrant, Job loser - on layoff, New entrant, Job leaver, Other job loser.</span>
<span class="s1">full or part time employment stat: Children or Armed Forces, Full-time schedules, Unemployed part- time, Not in labor force, Unemployed full-time, PT for non-econ reasons usually FT, PT for econ reasons usually PT, PT for econ reasons usually FT.</span>
<span class="s1">capital gains: continuous.</span>
<span class="s1">capital losses: continuous.</span>
<span class="s1">dividends from stocks: continuous.</span>
<span class="s1">tax filer stat: Nonfiler, Joint one under 65 &amp; one 65+, Joint both under 65, Single, Head of household, Joint both 65+.</span>
<span class="s1">region of previous residence: Not in universe, South, Northeast, West, Midwest, Abroad.</span>
<span class="s1">state of previous residence: Not in universe, Utah, Michigan, North Carolina, North Dakota, Virginia, Vermont, Wyoming, West Virginia, Pennsylvania, Abroad, Oregon, California, Iowa, Florida, Arkansas, Texas, South Carolina, Arizona, Indiana, Tennessee, Maine, Alaska, Ohio, Montana, Nebraska, Mississippi, District of Columbia, Minnesota, Illinois, Kentucky, Delaware, Colorado, Maryland, Wisconsin, New Hampshire, Nevada, New York, Georgia, Oklahoma, New Mexico, South Dakota, Missouri, Kansas, Connecticut, Louisiana, Alabama, Massachusetts, Idaho, New Jersey.</span>
<span class="s1">detailed household and family stat: Child &lt;18 never marr not in subfamily, Other Rel &lt;18 never marr child of subfamily RP, Other Rel &lt;18 never marr not in subfamily, Grandchild &lt;18 never marr child of subfamily RP, Grandchild &lt;18 never marr not in subfamily, Secondary individual, In group quarters, Child under 18 of RP of unrel subfamily, RP of unrelated subfamily, Spouse of householder, Householder, Other Rel &lt;18 never married RP of subfamily, Grandchild &lt;18 never marr RP of subfamily, Child &lt;18 never marr RP of subfamily, Child &lt;18 ever marr not in subfamily, Other Rel &lt;18 ever marr RP of subfamily, Child &lt;18 ever marr RP of subfamily, Nonfamily householder, Child &lt;18 spouse of subfamily RP, Other Rel &lt;18 spouse of subfamily RP, Other Rel &lt;18 ever marr not in subfamily, Grandchild &lt;18 ever marr not in subfamily, Child 18+ never marr Not in a subfamily, Grandchild 18+ never marr not in subfamily, Child 18+ ever marr RP of subfamily, Other Rel 18+ never marr not in subfamily, Child 18+ never marr RP of subfamily, Other Rel 18+ ever marr RP of subfamily, Other Rel 18+ never marr RP of subfamily, Other Rel 18+ spouse of subfamily RP, Other Rel 18+ ever marr not in subfamily, Child 18+ ever marr Not in a subfamily, Grandchild 18+ ever marr not in subfamily, Child 18+ spouse of subfamily RP, Spouse of RP of unrelated subfamily, Grandchild 18+ ever marr RP of subfamily, Grandchild 18+ never marr RP of subfamily, Grandchild 18+ spouse of subfamily RP.</span>
<span class="s1">detailed household summary in household: Child under 18 never married, Other relative of householder, Nonrelative of householder, Spouse of householder, Householder, Child under 18 ever married, Group Quarters- Secondary individual, Child 18 or older.</span>
<span class="s1">instance weight: ignore.</span>
<span class="s1">migration code-change in msa: Not in universe, Nonmover, MSA to MSA, NonMSA to nonMSA, MSA to nonMSA, NonMSA to MSA, Abroad to MSA, Not identifiable, Abroad to nonMSA.</span>
<span class="s1">migration code-change in reg: Not in universe, Nonmover, Same county, Different county same state, Different state same division, Abroad, Different region, Different division same region.</span>
<span class="s1">migration code-move within reg: Not in universe, Nonmover, Same county, Different county same state, Different state in West, Abroad, Different state in Midwest, Different state in South, Different state in Northeast.</span>
<span class="s1">live in this house 1 year ago: Not in universe under 1 year old, Yes, No.</span>
<span class="s1">migration prev res in sunbelt: Not in universe, Yes, No.</span>
<span class="s1">num persons worked for employer: continuous.</span>
<span class="s1">family members under 18: Both parents present, Neither parent present, Mother only present, Father only present, Not in universe.</span>
<span class="s1">country of birth father: Mexico, United-States, Puerto-Rico, Dominican-Republic, Jamaica, Cuba, Portugal, Nicaragua, Peru, Ecuador, Guatemala, Philippines, Canada, Columbia, El-Salvador, Japan, England, Trinadad&amp;Tobago, Honduras, Germany, Taiwan, Outlying-U S (Guam USVI etc), India, Vietnam, China, Hong Kong, Cambodia, France, Laos, Haiti, South Korea, Iran, Greece, Italy, Poland, Thailand, Yugoslavia, Holand-Netherlands, Ireland, Scotland, Hungary, Panama.</span>
<span class="s1">country of birth mother: India, Mexico, United-States, Puerto-Rico, Dominican-Republic, England, Honduras, Peru, Guatemala, Columbia, El-Salvador, Philippines, France, Ecuador, Nicaragua, Cuba, Outlying-U S (Guam USVI etc), Jamaica, South Korea, China, Germany, Yugoslavia, Canada, Vietnam, Japan, Cambodia, Ireland, Laos, Haiti, Portugal, Taiwan, Holand-Netherlands, Greece, Italy, Poland, Thailand, Trinadad&amp;Tobago, Hungary, Panama, Hong Kong, Scotland, Iran.</span>
<span class="s1">country of birth self: United-States, Mexico, Puerto-Rico, Peru, Canada, South Korea, India, Japan, Haiti, El-Salvador, Dominican-Republic, Portugal, Columbia, England, Thailand, Cuba, Laos, Panama, China, Germany, Vietnam, Italy, Honduras, Outlying-U S (Guam USVI etc), Hungary, Philippines, Poland, Ecuador, Iran, Guatemala, Holand-Netherlands, Taiwan, Nicaragua, France, Jamaica, Scotland, Yugoslavia, Hong Kong, Trinadad&amp;Tobago, Greece, Cambodia, Ireland.</span>
<span class="s1">citizenship: Native- Born in the United States, Foreign born- Not a citizen of U S , Native- Born in Puerto Rico or U S Outlying, Native- Born abroad of American Parent(s), Foreign born- U S citizen by naturalization.</span>
<span class="s1">own business or self employed: 0, 2, 1.</span>
<span class="s1">fill inc questionnaire for veteran&#39;s admin: Not in universe, Yes, No.</span>
<span class="s1">veterans benefits: 0, 2, 1.</span>
<span class="s1">weeks worked in year: continuous.</span>
<span class="s1">year: 94, 95.</span>
<span class="s1">income: - 50000, 50000+.</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UCI</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;https://archive.ics.uci.edu/ml/machine-learning-databases/census-income-mld/census-income.data.gz&#39;</span><span class="p">,</span>
        <span class="s1">&#39;https://archive.ics.uci.edu/ml/machine-learning-databases/census-income-mld/census-income.test.gz&#39;</span>
    <span class="p">]</span>
    <span class="n">raw_folder</span> <span class="o">=</span> <span class="s1">&#39;raw&#39;</span>
    <span class="n">processed_folder</span> <span class="o">=</span> <span class="s1">&#39;processed&#39;</span>
    <span class="n">training_file</span> <span class="o">=</span> <span class="s1">&#39;training.pth&#39;</span>
    <span class="n">test_file</span> <span class="o">=</span> <span class="s1">&#39;test.pth&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span> <span class="o">=</span> <span class="n">target_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="o">=</span> <span class="n">train</span>  <span class="c1"># training set or test set</span>

        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Dataset not found.&#39;</span> <span class="o">+</span>
                               <span class="s1">&#39; You can use download=True to download it&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">training_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_file</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_exists</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># download files</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Downloading &#39;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="n">filename</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_f</span><span class="p">,</span> \
                    <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_f</span><span class="p">:</span>
                <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">zip_f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># process and save as torch files</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing...&#39;</span><span class="p">)</span>

        <span class="n">name_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">property_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">uci_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
            <span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">values</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;continuous&#39;</span><span class="p">):</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span>
            <span class="n">property_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uci_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="s1">&#39;census-income.data&#39;</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uci_preprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="s1">&#39;census-income.test&#39;</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">name_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">value_set</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">))))</span>
            <span class="n">value_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value_set</span><span class="p">):</span>
                <span class="n">value_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
            <span class="n">name_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_dict</span>

        <span class="n">training_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uci_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="s1">&#39;census-income.data&#39;</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">)</span>
        <span class="n">test_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uci_process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_folder</span> <span class="o">/</span> <span class="s1">&#39;census-income.test&#39;</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">training_set</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_folder</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">test_set</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmt_str</span> <span class="o">=</span> <span class="s1">&#39;Dataset &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">fmt_str</span> <span class="o">+=</span> <span class="s1">&#39;    Number of datapoints: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">())</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="s1">&#39;test&#39;</span>
        <span class="n">fmt_str</span> <span class="o">+=</span> <span class="s1">&#39;    Split: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="n">fmt_str</span> <span class="o">+=</span> <span class="s1">&#39;    Root Location: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;    Transforms (if any): &#39;</span>
        <span class="n">fmt_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s1">&#39;    Target Transforms (if any): &#39;</span>
        <span class="n">fmt_str</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_transform</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">fmt_str</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">uci_preprocess</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">42</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># make list</span>
            <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">property_list</span><span class="p">,</span> <span class="n">name_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pp</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">uci_process</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name_dict</span><span class="p">,</span> <span class="n">property_list</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">raw_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">raw_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">42</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># make list</span>
            <span class="n">image</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">property_list</span><span class="p">,</span> <span class="n">name_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pp</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pp</span> <span class="o">==</span> <span class="s1">&#39;ignore&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">pp</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;education&#39;</span><span class="p">:</span>
                        <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;Bachelors&#39;</span><span class="p">,</span> <span class="s1">&#39;Some&#39;</span><span class="p">,</span> <span class="s1">&#39;Maters&#39;</span><span class="p">,</span> <span class="s1">&#39;Asso&#39;</span><span class="p">,</span> <span class="s1">&#39;Doctorate&#39;</span><span class="p">,</span> <span class="s1">&#39;Prof&#39;</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;marital stat&#39;</span><span class="p">:</span>
                        <span class="n">label</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;Never married&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># age</span>
                        <span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">40</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># normal</span>
                    <span class="n">one_hot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                    <span class="n">one_hot</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">word</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_hot</span><span class="p">)</span>

            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">labels</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataset-preparation">
<h2>Dataset Preparation<a class="headerlink" href="#dataset-preparation" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">UCI</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;/content/UCI&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Downloading https://archive.ics.uci.edu/ml/machine-learning-databases/census-income-mld/census-income.data.gz
Downloading https://archive.ics.uci.edu/ml/machine-learning-databases/census-income-mld/census-income.test.gz
Processing...
Done!
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pytorch-initialization">
<h2>PyTorch initialization<a class="headerlink" href="#pytorch-initialization" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>working directory</p></li>
<li><p>device</p></li>
<li><p>dataloader</p></li>
<li><p>utilities</p></li>
</ul>
<div class="section" id="checkpoint-paths">
<h3>Checkpoint paths<a class="headerlink" href="#checkpoint-paths" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ckpt_root</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/content/checkpoints&#39;</span><span class="p">)</span>
<span class="n">ckpt_root</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">sgd_path</span> <span class="o">=</span> <span class="n">ckpt_root</span> <span class="o">/</span> <span class="s1">&#39;sgd&#39;</span>
<span class="n">sgd_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mr_path</span> <span class="o">=</span> <span class="n">ckpt_root</span> <span class="o">/</span> <span class="s1">&#39;minres&#39;</span>
<span class="n">mr_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checkpoint root:&#39;</span><span class="p">,</span> <span class="n">ckpt_root</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SGD path:       &#39;</span><span class="p">,</span> <span class="n">sgd_path</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MINRES path:    &#39;</span><span class="p">,</span> <span class="n">mr_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Checkpoint root: /content/checkpoints
SGD path:        /content/checkpoints/sgd
MINRES path:     /content/checkpoints/minres
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="device-initialization">
<h3>Device initialization<a class="headerlink" href="#device-initialization" title="Permalink to this headline">¶</a></h3>
<p>We remove all random state.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>  <span class="c1"># use default cuda device</span>
    <span class="kn">import</span> <span class="nn">torch.backends.cudnn</span> <span class="k">as</span> <span class="nn">cudnn</span>  <span class="c1"># make cuda deterministic</span>
    <span class="n">cudnn</span><span class="o">.</span><span class="n">benchmark</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">cudnn</span><span class="o">.</span><span class="n">deterministic</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span> <span class="c1"># otherwise use cpu</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Current device:&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Current device: cuda
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="training-and-test-dataloader">
<h3>Training and test dataloader<a class="headerlink" href="#training-and-test-dataloader" title="Permalink to this headline">¶</a></h3>
<p>We use batch size of 256 for both training and test side.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">trainset</span> <span class="o">=</span> <span class="n">UCI</span><span class="p">(</span><span class="s1">&#39;/content/UCI&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">trainloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">testset</span> <span class="o">=</span> <span class="n">UCI</span><span class="p">(</span><span class="s1">&#39;/content/UCI&#39;</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">testloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">testset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training Dataset:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">trainset</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test Dataset:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">testset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Training Dataset:
Dataset UCI
    Number of datapoints: 199523
    Split: train
    Root Location: /content/UCI
    Transforms (if any): None
    Target Transforms (if any): None

Test Dataset:
Dataset UCI
    Number of datapoints: 99762
    Split: test
    Root Location: /content/UCI
    Transforms (if any): None
    Target Transforms (if any): None
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="utility-functions">
<h3>Utility functions<a class="headerlink" href="#utility-functions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>evenly distributed weights</p></li>
<li><p>top-k accuracies</p></li>
<li><p>evaluation</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">ret</span> <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">num_weights</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="n">dim</span><span class="p">)</span> \
            <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">topk_accuracies</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">ks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)):</span>
    <span class="k">assert</span> <span class="n">logits</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="n">targets</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">targets</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">maxk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">maxk</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

    <span class="n">accu_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ks</span><span class="p">:</span>
        <span class="n">accu</span> <span class="o">=</span> <span class="n">correct</span><span class="p">[:,</span> <span class="p">:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">accu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accu</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">accu_list</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">closures</span><span class="p">,</span> <span class="n">topk_closures</span><span class="p">):</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_losses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">closures</span><span class="p">))</span>
    <span class="n">total_top1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">closures</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">network</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="n">num_samples</span> <span class="o">+=</span> <span class="n">batch_size</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">logits</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">closures</span><span class="p">]</span>
            <span class="n">total_losses</span> <span class="o">+=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
            <span class="n">topks</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">topk_closures</span><span class="p">]</span>
            <span class="n">total_top1s</span> <span class="o">+=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">topks</span><span class="p">)</span>
    <span class="n">total_losses</span> <span class="o">/=</span> <span class="n">num_samples</span>
    <span class="n">total_top1s</span> <span class="o">/=</span> <span class="n">num_samples</span>
    <span class="k">return</span> <span class="n">total_losses</span><span class="p">,</span> <span class="n">total_top1s</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Example of evenly_dist(num_weights=5, dim=3):&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">combination</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">: (&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">digit</span><span class="p">)</span> <span class="k">for</span> <span class="n">digit</span> <span class="ow">in</span> <span class="n">combination</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Example of evenly_dist(num_weights=5, dim=3):
1: (0.167, 0.167, 0.667)
2: (0.167, 0.333, 0.500)
3: (0.167, 0.500, 0.333)
4: (0.167, 0.667, 0.167)
5: (0.333, 0.167, 0.500)
6: (0.333, 0.333, 0.333)
7: (0.333, 0.500, 0.167)
8: (0.500, 0.167, 0.333)
9: (0.500, 0.333, 0.167)
10: (0.667, 0.167, 0.167)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="empirical-pareto-front-generation">
<h2>Empirical Pareto front generation<a class="headerlink" href="#empirical-pareto-front-generation" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="sgd-preparation">
<h2>SGD preparation<a class="headerlink" href="#sgd-preparation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>hyper-parameters</p></li>
<li><p>network</p></li>
<li><p>loss function</p></li>
<li><p>optimizer</p></li>
<li><p>learning rate scheduler</p></li>
<li><p>inital state snapshot</p></li>
</ul>
<div class="section" id="hyper-parameters-declaration">
<h3>Hyper-Parameters declaration<a class="headerlink" href="#hyper-parameters-declaration" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>num of epochs</p></li>
<li><p>num of different weight combinations</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">num_weights</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="network-definition">
<h3>Network definition<a class="headerlink" href="#network-definition" title="Permalink to this headline">¶</a></h3>
<p>We use a double-layer MLP with a fully-connected layer for each task.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MLP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">487</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_age</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_education</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc_marriage</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fc_age</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_education</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_marriage</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

<span class="n">network</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">network</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Network:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">network</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Network:
MLP(
  (fc1): Linear(in_features=487, out_features=256, bias=True)
  (fc2): Linear(in_features=256, out_features=128, bias=True)
  (fc_age): Linear(in_features=128, out_features=2, bias=True)
  (fc_education): Linear(in_features=128, out_features=2, bias=True)
  (fc_marriage): Linear(in_features=128, out_features=2, bias=True)
  (relu): ReLU(inplace=True)
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="loss-function-definition">
<h3>Loss function definition<a class="headerlink" href="#loss-function-definition" title="Permalink to this headline">¶</a></h3>
<p>We use cross entropy loss for two tasks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">closures</span> <span class="o">=</span> <span class="p">[</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">criterion</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">criterion</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]),</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">criterion</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>
<span class="p">]</span>

<span class="n">top1_closures</span> <span class="o">=</span> <span class="p">[</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">topk_accuracies</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">],</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">topk_accuracies</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">],</span>
    <span class="k">lambda</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">topk_accuracies</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">ks</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="optimizer-definition">
<h3>Optimizer definition<a class="headerlink" href="#optimizer-definition" title="Permalink to this headline">¶</a></h3>
<p>We use SGD with learning rate of 0.001 and momentum of 0.9.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SGD (
Parameter Group 0
    dampening: 0
    lr: 0.001
    momentum: 0.9
    nesterov: False
    weight_decay: 0
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="learning-rate-scheduler-definition">
<h3>Learning rate scheduler definition<a class="headerlink" href="#learning-rate-scheduler-definition" title="Permalink to this headline">¶</a></h3>
<p>We use cosine annealing learning rate scheduler for training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">CosineAnnealingLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_epochs</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">trainloader</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="snapshot-for-inital-states">
<h3>Snapshot for inital states<a class="headerlink" href="#snapshot-for-inital-states" title="Permalink to this headline">¶</a></h3>
<p>The initial weights / optimizer / lr_scheduler are saved for further training (we removed <strong>ALL</strong> randomness).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">init_ckpt</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="n">network</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
    <span class="s1">&#39;lr_scheduler&#39;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">init_ckpt</span><span class="p">,</span> <span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;init.pth&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="let-s-train-it">
<h2>Let’s train it!<a class="headerlink" href="#let-s-train-it" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
    <span class="n">init_ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;init.pth&#39;</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>  <span class="c1"># load init snapshot</span>
    <span class="n">network</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">init_ckpt</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">init_ckpt</span><span class="p">[</span><span class="s1">&#39;optimizer&#39;</span><span class="p">])</span>
    <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">init_ckpt</span><span class="p">[</span><span class="s1">&#39;lr_scheduler&#39;</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">epoch_iter</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epoch_iter</span><span class="p">:</span>
            <span class="n">network</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">trainloader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Batch&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">logits</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
                <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">closures</span><span class="p">]</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">l</span> <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">losses</span><span class="p">))</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">eval_losses</span><span class="p">,</span> <span class="n">eval_top1s</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">testloader</span><span class="p">,</span> <span class="n">closures</span><span class="p">,</span> <span class="n">top1_closures</span><span class="p">)</span>
            <span class="n">epoch_iter</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;acc-</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">top</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eval_top1s</span><span class="p">)})</span>
    <span class="n">ckpt</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="n">network</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;lr_scheduler&#39;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
        <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">eval_losses</span><span class="p">,</span> <span class="n">eval_top1s</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f34fd8a7749f44289a5f35c23e322a73", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8b57c1654a63470a9514b19217e4dc9b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "68f22bc927e54472839b1136fff44d5c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f1d78cf7acf541c293ccda40dad95ffc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b3ae91a2207d46b597baf6287bfa9af8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "40aaf5da585c475c88fc791bb180f373", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5eab04ea63024901a2bdcb374da4d061", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c1f1fa706b0645109bb318a5201215ec", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b502bb24035442bf8cc745984b0781d7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "835f65429248466580b7c83b8f351b8c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6a8f660c32d14912a986489f546b05b3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "461f7aaab8bb4fc9ae025e84d85425e0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8468a90079ec40818ab6f915c3340273", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "888d0376f1da4af3a93aa004f822e1e7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "448df487ee644030b5f53fc5cedfbbd6", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2b27d019bb094016ab4b0cd53ab9e00e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a2e77e3fc19d408d9c974c4694540aa5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "08c73fb6595246918ad785453145d6cf", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7cba9e028dab451badec09b59ab64b00", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4865b7d8bb1447379aeb571c283497b3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "29913009445d41d8b085dc33147b9031", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2e769b691fbd4db596a2ba69c389bcbc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2306c4a6d396470ba9ab56d55c4181df", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c78a7a726bfb457c9ce57a31160c5bd4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e2ffb666191844a3b27a3c33df335398", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "00983befb1774dce94b91081156fc9d8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d5ac3f0542fd4605b2e7e3a39e920698", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "affbbf60fc37435cbb0c2f0817477609", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2dee30c42e3a4cb3990221fbe1c3d6c9", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0eb98d80d8024a74bc1f59419ae00e53", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "35ab1575a2a9458d9be5d9fbe75db7a3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "161fd88ee384468a807de12501541a00", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fcf4834958db406fa0e559dbd5f038ac", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4098a6d051f8459490b07f99890e4564", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "018ab3af97144dbab3616233aca14582", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ef80494238e8486d92c096a55e2795fb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6aeb4a9543ea41f483eee23310443124", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9e833bbe916a41c793ca25e1183d6fa1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b82a0ec61687445198175e88c9c177c7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a5b12d7ab3ef47cf8b4b82cd13cd7c79", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "78b554e78a15407d8f32d3a86e810fba", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3fb51009961d46d8971f2ce809710907", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f45a66b0f4a54dc089e8abe837d01bb5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "dc8be5bab7d844dcae6e2604dc81d80c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b6148feb383841ae869c8ce24caae339", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a391409e60d441fe850cdb9ff08a204c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bf58b99158ce4a01a2014199c0dfa305", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8f1fb9c2ae47430cbd9490c55625bf20", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "73a1c0eab3294c2cab7bfcaca959b760", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d9b6836005914eb2bd682cbf919b644e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c5357621b33541a28da5574dd1971aba", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fa7d4711012c4a939d3af2a393387d24", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "469c83d405764ed88c0c70a79c0152d7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c2a44e3406fc45729b1b34fc11d96aa1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "81c3038b79454ee7a833a7e3a40a17b8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "763d843da37c40769c8d50ba60a2b0cd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "44aafeb4f0254369b9e02566d16e270e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "667e37cec6f746e792ec9ed8ea01e9db", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "79dc31cf8470483f9a358f9128770e60", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1e3e3ea43bf64df090e3102a0a38d7dc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1e44ee6443e74086bf5f20eb6f8be7e8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bf60a4012afc4714b253ea14e9449f81", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9f7b4344e922415ba3113435ad70961d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "48194c48b5f74ca19a8caee169223a30", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "571db36b7ce445dfb7f784a072985779", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f47036a831324cd0b3dcc50b828ea35e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6a16546fd59543e8891ad660ace77fc4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ed197b47420c4309a732453e84e8158c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6de56a14b6e14a3eba8eda81969a22e0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f7563caa5225437ca1251955dd8150f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "56fbeada8d18402bbb126ab1dd267b25", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8d8a3dff872740f7830c56db4b8d27ab", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1ef929f0b5f9471c8cb023b049aa85f5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "318a6d22d749495ba8d00c53e9859eee", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "785643a536cc436ebc4f36cf5e27af00", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2d45eb26331c407699c6d52cfc4d3ddd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "edc4b5a5c1a34a7a9e0a46966c3676e6", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "105660faa2cb4ead97bd2a887764fec0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6760caf3d5c8471e83433be89958487d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0efb7a0d9b89438683e32b2ed6dda66a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5412f63e93f345b4a9bae1a88128c8e3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1acea8d75ee84b2898bc6e94bc238566", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "14451c43f1e2462f932e33158b4d6391", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8a2d018613ab4b49b74682cfffe0ce22", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5bd94dde7a904834ade5ce9f3c01f809", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "688c30f534ea4b3c9e29ccfc8609b6c5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9ed62363a524453bb81465e33d9825b3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "41ffedd97da04248b2d7fc91c809786e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0d35656083fb4d74927e7f2f5a844c7e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2646f79eb72d47329e88414aacaf4554", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3c4bec3303bb4806b9701ad49a51b378", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "da60c51861ed4b59bb0d42ec8100aef3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e999f684c2ee4c08aaeaf964fd52d9c2", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "91531b63c00e4c17a791ba53ef030558", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9c5fe5d015124f3d87a674856ea180aa", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e71f7b0be81640f5abde1d517b9ec7e8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2a92ff9204b74beb87c686192651df07", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "81562388f15c440f82e36000238826dd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d9818fff1a994bcfa3981d92d0220146", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c9ea6639aad94ff6b15548869c4de15e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "78628137ea9542ac91852652459f37f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "919785aa65334eb6872651318da7af37", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "37f713ac988644269ef984591846fb7b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "95b682f592154ebd94a913ec22fa8c54", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f55e65215dce42d9a4c2a71eabfb6f49", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bed44050dca84d4db3156142c6b4455b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "555736f336d445cbae11a43f4ece666e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f842ab2f0f80457a8406deee54700f4a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3530e6a620234ce68274472c61587722", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8311b55f8159487eb1a10af239ebbdf5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1157c9c6a16640099e9e31c55a8eb388", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "719542ce49c54685a200f1d571a61b2a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9bee117faea94bd4a693651224abe30c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "dcab01e712db4d3284857d63f6677bcb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "800895a797d84dd18fb35253152ca3d0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e119536c51964cc0b95abca1c897a452", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0d2560d2fa8e4713a24f5fc7fa9d1ffc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "843aeeb5dcc24479a31846f68e89d048", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b6e590f4114d49c99f37ab4bb97bf8b5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "48d41a216d60466cb439ab591fb51faf", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2e8ec390e1e04bca92f1abc26d24b7ea", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "80f03f1ee8a44bff92df6b39e720185f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d27e78fc9f064b7e969947a711aa9418", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "07bf64cabf5944a58365682933fc9e1e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bb9752b2671e4855aed9169434f44d97", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a4c0ed8c796e4e3193cd08cc9f191e85", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "795f9f7eb77d4be1b088e1a0e3f6ac42", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3ef923b65e4947c18163d861a58c0887", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "96f4b07dc99c4652ae38a4b3f5083905", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "58f4e8958c37492692c8ff23a7fba0c8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "966628cbbad44ce98bf9c8911988c564", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7370cda0a9c54d7db4196ab3f5d43d76", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a3b3fbb4324a44f59e68eed1df37d60d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "81baa3fc90034bbb9fe9c6660717362f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e99dae6bb5f940aea3f3fca0583c2371", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b2cbf1f1ef4244078faa9572d602f12b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "24433387f6824b12a2478cc2a593a7e3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e409abc7a9c44d8abf392c5bd54749f5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "30b180f5514743d98f89638ac31540f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a9673d605adc4b04bf73b46a735f8cc9", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "54abf38af52a4091abbef8984c454098", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f9247ce2275c45868f9401058e135cf5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "af746474045e4b4782247d183a632eb8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "058ce5ab4ad94c9e9833b68f2ad54006", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6692f32a5b5448ed8dc23de9c13e13db", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7fc38d207d6944419943b4854206431d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4399451c09094f15a827f17b97b340ef", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "35cedb3eb62a4e429b76e4f597a0534e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8acaff00e05d4145854b730d49f6312e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f96a7b410516457c99dc8e597ac149eb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "efba0223386b4331b58458858711ab5c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "81c1badedd314ff0a44f09e01afcb37b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0ea11aeb3f3845dd85e7688b11cf83ba", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "eae78ee678814620a3a996e00987668f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a0e1f4decacc4f50acab1b3b76a230fe", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a53d163a61ef4a6c83be9ce4ed7f2f27", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "984804abd3314d7ba99cec7d2e6d8f43", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "05fc7a20c5924cc3a08620d71dcab4c2", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a36c7973f447408da912ef2154c94b26", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cf3d33c044ad453e8131b0f90217cfc3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "49987aac21c94cacb626621c4abdf67d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c3f62e9bab1540149b8b12f9accb5055", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e20507566ec544bbba99de2700bf6eab", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b77c3424dcf24bd096c2c953a9782fa2", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3910453421964d94898f0f4069d90924", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d286b1ae68664fccb404b61603212401", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "32ccac30eb9948378b6b9b793ba2148a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "250c04fbfebf4ebb99413ad29fab99a4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b7ffc9e6ebc347debe54b44a4886211f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "017c63eb82034e478e3d8d0fd3d46ccf", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fa9a69cc271d40cd8accb406d60e2199", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7804c1ec0afd4a1c9093df1f495480eb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5b7d9486c22842438c96bba7549015fa", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9aa50e8ae42147e9bbc292c54cc26444", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7c4c0ca46f3f4e868e0fb28634921534", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bae68b74ee7f4567932d96086687c9f4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "041894b7d4ba45a6a63d74dc8441e602", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "098227456eeb46748a4c22628e03e1ed", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "36a5bfd8654a43cb8aa45a4196d6a74b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9bf37af7909c4ff59f99986ae22e2143", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "77974a436b3f4444906c19f1f1b8fa26", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4cd7aac0e3874e8cada9015da788036e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "02ab2cf5edda4c918a3e706c0e3d177d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "18cc3c1d7ba44c25a79e8c8303b14c5b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "11339a3bc62f4509a4106d85b05d2292", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0e9789725724469aa18632a3cdd42071", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "563d642a8a124f8abf9e2cdf2257baeb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6048201ea28641cd808e0e2fde4417cd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "dd8b1d01ad3742368ce39f2e0f466b16", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4ca0062896094e69b5c0e95fe3c3fa16", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7f9dac9c293a4ce187da0206a402af81", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "082193d21781485984f71ad73b593db1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8aaddbee2e68499f9caf8df3c5f16e49", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9cb30dfb894a4fd2b28fd4edccb7c45e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1eaf85b1a2044950b39597a89d6838a7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5930107966cb4a508291ba4e767b9675", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "742134948d374785a224e83dc901567e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "dbcfb9a1e4e14d4baa66952681374224", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4b4920ccc5ea493a921aefea9299a799", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "86495fee2b304c97963d35dd0f3780bb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "82fbe0a9433c4ed6aba2ffbd511e9894", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8b9bd301bcc148e2a438913a370a5642", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "73088d3b2aaf452bb3a9d4ffd3f16cf1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7850fb5265d04da7b69c58d361be9883", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a5853a82f393448ea9584745ad423e3b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "af81644a21e5483e877f63dd1729fd59", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "84e97cb26e1a4e7ea2683c3adffaecec", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4e6eafbae65f4f118ac92b7650f06037", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "37bcf68824a84b829ebe68fa934e16ef", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8dd680965f4f4c2186ec43d0389ff88f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "71f034ccebce4ec7b900ee92dcb4fd35", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2a527944315b4b5094dac015c6631305", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "274acf60390f4bd0b619d0f4a8ec91bd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "400fc5d4aec7414ea100232ff90e1dad", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cfe43b93b58d4ab1afd70b97966f48ee", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3ae1794ef1da46f39a4499661b3c1c80", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6316d39814164517abbefd07b86a8060", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "420705b16057403b989c8b218e123040", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "34631023fea840e08879a9ed23cd27b8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "68b2ebaa53014b4494ef51404f55a5cc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9a4331d16693410dab52dd5bdad12795", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f68cbfd328cb48b9836e96c6f778acd5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "606f893c08634003aae4d04dc64923a8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5d2c9a4b87a14a03adcdc7731d2ce8f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5af554cf770a4ca2a203959d77bbca3e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "25dbda762ca24ce1b8f5af05d3cbcba7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2c97ebce9f89474a83eae234631f8e43", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "966eb7340f464156b4dd5e508c0a65f5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b0b1694957d94a44bd35a25c916243c5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "501074151f6144fbbc35b4f50fc85fcc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9f6eac1941fd4854bb132f97cb07a7e5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4a99e16e59ed4df69e77ba886292b4c0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "24ca927d0a504c11a0fb6aac4afbdbfc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3cf9b7c4552f4b5c96ede0a61d101329", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "49a94dc946aa4026a243aa398a00a2b7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "df42ec6dcffd4e5bb10a4bbc8a63b37e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "67f779d1dbeb4c19b93234c661d9fc81", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3da464e22ab04d7b94e25cb2082a61b1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0223038c63944b419512825e5e82c9ef", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "370b4d4331a24faebdb2a67b0f02cf7a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "593b45981b0f4ad1bb1b99a529ca7165", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8b6633e049484d60862a583c16921fef", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "998fc7d4abd549c7b75137122a35286c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "723eefc8ec1b411cba50c9749f99a1fd", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "69ed50ae3a4342d6a63a363dcac1c244", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7b21dbcd8f2343db9ce9f042900168f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e170e3239d47463cb9bf1f2489a04e23", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "897029c308294e119a34098792fc59d9", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3fe14c046e7847408cb7d5efd62e5a67", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ebef4649aaa54d10a01518e368b81203", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5723daeeac94484a93c4f5e0613abd66", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ace3925cb52547cdad2f3ffebfb7d274", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4796c1688acd46c78b390a6e0291190b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a26d35a2f7044b268a37c8621afcccec", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "08ed9f4007204f9dbd59e51ad0574b63", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "118cb347c5bc47ddbabc91c95ff48d0e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "36903124da564e13b23a6912acc723fa", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5861e2216a55471f972fa3824c7b8197", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5254854b0da9453f87d1342ce49e3316", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "13eeac211b2d49a1ad75b40158f10396", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d330c7479ab44658b5bfc363633b1357", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fbe94ba7527c488194cb0d50a79739f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "7de7996138aa4227abed4729a23bf79f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8118923078294687a207606056bc3977", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "536ef61504b447d28d7d1bd7a153362b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5029005634db436aaf8b9a50b9af9423", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c81f4238924749f6badcf64ce44708ce", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b09231283bac4c8eb7b9c3429f4e6a52", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "98d43f6402b94079a2b5ea0e30e18f59", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2d8cb1cf19fd4649b0307490f0b71d3d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "328a1d699ad6491ead743e53b01b5458", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6e946cc521f1413dba7d3bcc5dda852d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2a9d05a8c0a84b20a4fddd515825e473", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ea807e42150241b2924452a7da0a2fd0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8a744dd6925f4b6aa6adf7934cb61dd1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b17d92721e864d55a50d7c25a17fd214", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ed2e4d1792a945c7aa6a242b71f9d7ad", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "395444bb8e254a048ac2397e2124ceab", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0621a48fa6ab41748e0821094384a85d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "64ee547f3f4547efa75d3c92cee981ad", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "1834fb380c894ab88130b3f90de10a88", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "db716ed68b3a4d668968bca1dab2efd4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "137e453d9e274780ae5c07ceda32ffa4", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d24976319bfb4b879311599b439b661f", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "80b6aa2facb3444b8acca1141df503d1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2604cd8618e8487b8621710e5a57d718", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "40a1fb1ffded4cca87e2b9152d324684", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8dc220d27ce34cbd92150494c3266b67", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d48cc64e912c4e488a60063be3c24985", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f6accfd56bd54cb8bef8d1d752513ee2", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2fd346f2fa5f43a2b6d67ffa7ad53273", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "57a7be9aee5c42b6b9aebee89d99187c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6be0a009caaf4299b96c9032fa32153d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0b275f8e7dfb436f956f5fd686d9cde0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "35819563d66a46fa963175434402d7fb", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "5e97b0f9672b494e8ee3c545ee877dad", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0e3c4f21647f43849e2b3ea9e0a5e89b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fc2d81df460242f981c6a0039e194ae3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "23e0e94fd0fe4135a8b7ae69bfde6ec2", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "affe49b757094278ad1ed5127adbd3f3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "98ff70a14b114d38b16fc6a031ced131", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9599f8ee8ee148d7b23698188fefa25e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "654587e1e4d5444f8f028186dd82ebb3", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4e35eaa8291c4aa4864341500a06d847", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e5a09a2de16d4fd38e1354382443c32b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a929623453594944991cb42b4061487d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "acc647fc06ee4e6aa7f6dde045aa5d77", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "66fcf5936c0e4833be574498faa9a845", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0879d31f03844c1fbf66b1095306fb6e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "befb92e669814e759bd29e94abb2b052", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "57637619de204c27a96039266f3aa311", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</div>
<div class="section" id="sgd-results-illustration">
<h2>SGD results illustration<a class="headerlink" href="#sgd-results-illustration" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">proj_type</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">))</span>
<span class="n">total_top1s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
    <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">losses</span><span class="p">,</span> <span class="n">top1s</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
    <span class="n">total_top1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top1s</span><span class="p">)</span>
<span class="n">total_err1s</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">total_top1s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">total_err1s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;SGD&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Task 1 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Task 2 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Task 3 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census_38_0.png" src="_images/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census_38_0.png" />
</div>
</div>
</div>
<div class="section" id="minres-based-pareto-exploration">
<h2>MINRES-based Pareto exploration<a class="headerlink" href="#minres-based-pareto-exploration" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="minres-preparation">
<h2>MINRES preparation<a class="headerlink" href="#minres-preparation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>hyper-parameters</p></li>
<li><p>dataloader</p></li>
<li><p>optimizer</p></li>
<li><p>Jacobian solver</p></li>
<li><p>linear operator</p></li>
<li><p>utilities</p></li>
</ul>
<div class="section" id="id1">
<h3>Hyper-Parameters declaration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>num of steps</p></li>
<li><p>damping for linear solver</p></li>
<li><p>maxiter for MINRES</p></li>
<li><p>momentum for Jacobians and alpha</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">num_steps</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">damping</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">maxiter</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="dataloader-definition">
<h3>Dataloader definition<a class="headerlink" href="#dataloader-definition" title="Permalink to this headline">¶</a></h3>
<p>We explore based on 2048 data samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mr_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">trainset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id2">
<h3>Optimizer definition<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>We use SGD with learning rate of 0.01 (<strong>without</strong> momentum for fair)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mr_optimizer</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">mr_optimizer</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SGD (
Parameter Group 0
    dampening: 0
    lr: 0.01
    momentum: 0
    nesterov: False
    weight_decay: 0
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="jacobians-solver-definition">
<h3>Jacobians solver definition<a class="headerlink" href="#jacobians-solver-definition" title="Permalink to this headline">¶</a></h3>
<p>We iterate over trainset to solve jacobian with respect to each task.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jacobian_trainiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">trainloader</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_jacobians</span><span class="p">(</span><span class="n">ratio</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">jacobian_trainiter</span>
    <span class="n">num_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trainloader</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
    <span class="n">jacobians</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">jacobian_trainiter</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">jacobian_trainiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">trainloader</span><span class="p">)</span>
            <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">jacobian_trainiter</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">closures</span><span class="p">]</span>
        <span class="n">param_grads</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">allow_unused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">param_grad</span> <span class="ow">in</span> <span class="n">param_grads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">param_grad_module</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_grad</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">())):</span>
                <span class="k">if</span> <span class="n">param_grad_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">param_grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">sub_jacobians</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">parameters_to_vector</span><span class="p">(</span><span class="n">param_grad</span><span class="p">)</span> <span class="k">for</span> <span class="n">param_grad</span> <span class="ow">in</span> <span class="n">param_grads</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sub_jacobians</span><span class="o">.</span><span class="n">detach_</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jacobians</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jacobians</span> <span class="o">=</span> <span class="n">sub_jacobians</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jacobians</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">sub_jacobians</span><span class="p">)</span>
    <span class="n">jacobians</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">num_batches</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jacobians</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="alpha-solver-definition">
<h3>Alpha solver definition<a class="headerlink" href="#alpha-solver-definition" title="Permalink to this headline">¶</a></h3>
<p>We solve alpha by its analytical solution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_alpha</span><span class="p">(</span><span class="n">jacobians</span><span class="p">):</span>
    <span class="n">sol</span><span class="p">,</span> <span class="n">min_norm</span> <span class="o">=</span> <span class="n">find_min_norm_element</span><span class="p">(</span><span class="n">jacobians</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sol</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="linear-operator-for-hessian-vector-product-definition">
<h3>Linear operator for Hessian-vector product definition<a class="headerlink" href="#linear-operator-for-hessian-vector-product-definition" title="Permalink to this headline">¶</a></h3>
<p>We warp Hessian-vector product into a linear operator to prevent explicit computation of Hessian.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HVPLinearOperator</span><span class="p">(</span><span class="n">LinearOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
        <span class="n">network_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">network_size</span><span class="p">,</span> <span class="n">network_size</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">dtype</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HVPLinearOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">dataloader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_jacobians</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_jacobians</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataiter</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataiter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">)</span>
            <span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataiter</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="n">losses</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">closures</span><span class="p">]</span>
        
        <span class="c1"># Get jacobian with respect to each loss.</span>
        <span class="c1"># `allow_unused=True` to get gradient from the unused tail.</span>
        <span class="c1">#     It returns `None`, which will be filtered later.</span>
        <span class="c1"># `retain_graph=True` to retain forward information for</span>
        <span class="c1">#     second-time backward.</span>
        <span class="c1"># `create_graph=True` to create computation graph for</span>
        <span class="c1">#     second-order derivation.</span>
        <span class="n">param_grads</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
            <span class="n">l</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">allow_unused</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">create_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">losses</span><span class="p">]</span>

        <span class="c1"># As metioned above, `allow_unused=True` leads to `None`s in</span>
        <span class="c1">#     jacobian tuple. Now we replace it with a zero tensor.</span>
        <span class="k">for</span> <span class="n">param_grad</span> <span class="ow">in</span> <span class="n">param_grads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">param_grad_module</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">param_grad</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">())):</span>
                <span class="k">if</span> <span class="n">param_grad_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">param_grad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                    
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">parameters_to_vector</span><span class="p">(</span><span class="n">param_grad</span><span class="p">)</span> <span class="k">for</span> <span class="n">param_grad</span> <span class="ow">in</span> <span class="n">param_grads</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">jacobians</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_jacobians</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_jacobians</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">jacobians</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_jacobians</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_matvec_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor</span><span class="p">):</span>

        <span class="c1"># hvp = Hv</span>
        <span class="c1">#     = dot(∂^2(f) / (∂x)^2, v)</span>
        <span class="c1">#     = ∂/∂x(dot(v, ∂f/∂x))</span>

        <span class="c1"># dot = dot(v, ∂f/∂x)</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_jacobians</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
        
        <span class="c1"># hvp = ∂/∂x(dot)</span>
        <span class="n">param_alphas_hvps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">alphas_hvps</span> <span class="o">=</span> <span class="n">parameters_to_vector</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_alphas_hvps</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">damping</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">alphas_hvps</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">damping</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">alphas_hvps</span>

    <span class="k">def</span> <span class="nf">_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HVP matrix-vector multiplication handler.</span>

<span class="sd">        If self is a linear operator of shape (N, N), then this method will</span>
<span class="sd">        be called on a shape (N,) or (N, 1) ndarray, and should return a</span>
<span class="sd">        shape (N,) or (N, 1) ndarray.</span>

<span class="sd">        In our case, it computes alpha_hession @ x.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matvec_tensor</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>Utility functions<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>assign parameter.grad from vector</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_grad</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">vector</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">network</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
        <span class="n">numel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="c1"># view as to avoid deprecated pointwise semantics</span>
        <span class="n">p</span><span class="o">.</span><span class="n">grad</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">offset</span><span class="p">:</span><span class="n">offset</span> <span class="o">+</span> <span class="n">numel</span><span class="p">]</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">numel</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="let-s-explore-it">
<h2>Let’s explore it!<a class="headerlink" href="#let-s-explore-it" title="Permalink to this headline">¶</a></h2>
<p>Executing this section takes around 30 to 45 minutes depending on your GPU types. However, for the results reported in the paper and supplemental material, our training process is typically a lot faster than here because of the following reasons:</p>
<ul class="simple">
<li><p>For reproducibility, we disable randomness in this script as much as we can. Therefore, parallalism on GPUs is not fully exploited;</p></li>
<li><p>We frequently evaluate and save the model inside the innermost loop, which creates a lot of overhead;</p></li>
<li><p>Since the MINRES implementation is from scipy and is on CPUs, calling <code class="docutils literal notranslate"><span class="pre">HVPLinearOperator</span></code> creates a lot of CPU-GPU communication. Ideally, a GPU implementation of MINRES could completely remove this communication and expedite the training process.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">linear_op_template</span> <span class="o">=</span> <span class="n">HVPLinearOperator</span><span class="p">(</span><span class="n">mr_dataloader</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Direction&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="n">mr_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="s1">&#39;</span><span class="si">{:0&gt;3b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">linear_op_template</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># load SGD starting point</span>
        <span class="n">init_ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="n">network</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">init_ckpt</span><span class="p">[</span><span class="s1">&#39;state_dict&#39;</span><span class="p">])</span>

        <span class="c1"># initalize momentum buffer</span>
        <span class="n">jacobians_buffer_tensor</span> <span class="o">=</span> <span class="n">compute_jacobians</span><span class="p">()</span>
        <span class="n">jacobians_buffer</span> <span class="o">=</span> <span class="n">jacobians_buffer_tensor</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">alpha_buffer</span> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><span class="n">jacobians_buffer_tensor</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="n">num_steps</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Step&#39;</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">step_iter</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">step_iter</span><span class="p">:</span>
                <span class="n">network</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># compute jacobians</span>
                <span class="n">jacobians_tensor</span> <span class="o">=</span> <span class="n">compute_jacobians</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span>
                <span class="n">jacobians</span> <span class="o">=</span> <span class="n">jacobians_tensor</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">jacobians_buffer</span> <span class="o">*=</span> <span class="n">momentum</span>
                <span class="n">jacobians_buffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">momentum</span><span class="p">)</span> <span class="o">*</span> <span class="n">jacobians</span>
                <span class="n">jacobians</span> <span class="o">=</span> <span class="n">jacobians_buffer</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># compute alpha</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">compute_alpha</span><span class="p">(</span><span class="n">jacobians_tensor</span><span class="p">)</span>
                <span class="n">alpha_buffer</span> <span class="o">*=</span> <span class="n">momentum</span>
                <span class="n">alpha_buffer</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">momentum</span><span class="p">)</span> <span class="o">*</span> <span class="n">alpha</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha_buffer</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># define rhs and x0</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mr_weights</span> <span class="o">@</span> <span class="n">jacobians</span><span class="p">)</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">jacobians</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="c1"># fill jacobians alpha rhs x0 to MINRES</span>
                <span class="k">with</span> <span class="n">linear_op_template</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">as</span> <span class="n">linear_op</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">minres</span><span class="p">(</span><span class="n">linear_op</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">as_tensor</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">linear_op</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

                <span class="c1"># optimize</span>
                <span class="n">mr_optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="n">assign_grad</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">mr_optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="n">eval_losses</span><span class="p">,</span> <span class="n">eval_top1s</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="n">testloader</span><span class="p">,</span> <span class="n">closures</span><span class="p">,</span> <span class="n">top1_closures</span><span class="p">)</span>
                <span class="n">step_iter</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;acc-</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">top</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">top</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eval_top1s</span><span class="p">)})</span>
                <span class="n">ckpt</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;state_dict&#39;</span><span class="p">:</span> <span class="n">network</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">mr_optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">eval_losses</span><span class="p">,</span> <span class="n">eval_top1s</span><span class="p">]</span>
                <span class="p">}</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">mr_path</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="n">save_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">save_path</span> <span class="o">/</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "cec77f6eea4143cb87e21b175d6ffbda", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d10d69e74332469c92e80eae0370f319", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e1d9bc7582704803ad06504b1d501105", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "14b426fee0f541aabb052ef9efe95986", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f07d2e40374c4327ae68f9ffb93a35d8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c7b07fa08e38440d937298ff63f70048", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f9304006cd434237b100588bfde74d74", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8efed44bc8d34d489158cb4d1bf3dd13", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4e97fc228fe34eed8edf441f28a59bbf", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a76525990d0742e892a1f2205bdc9559", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9728b061614644db84ebe440ac802a00", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "adc848fa23f448429e48297c23d4ca29", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "fe9fdaed3c114fb494148b5323892530", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9588731592ff4732939877a609c4bf0b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "42216e9a8af244fa9dcee50854bf5aa5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9efe883c74564eb4865e6b65f132566b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "04cf993319dc495fa07c77407153b9f7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "bccddb55a64b4c348e177ad6bc81d1e8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2f20bf0f94d944aeb3372fca75823e66", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c5834939cce442d6a261281ee5486eb8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e17504a6b1a14aa09ad39739a3378a7a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e481bfd03a99486681ec1a1e4fc0df69", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "66194aba21a9494e9ea238fd6e80d7b1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6f3c40cfd8c74d21b716a626ef064a32", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c939fe7a91f145daa7919bdc3ae3c1ea", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2bec89e2e9c04ea6b86acdd52cfbb415", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "68aa826eee2841d1be7d2f3e142ce05a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "838b5837d84147c4a0eb39d560acb65c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a6f799d51750401c99593df88a04f63a", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4d0934e650d64acda673099e06643d9c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "ac773231ec4f47d5a917cd34bcc80961", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8182de330d4b4753997d74fa08330c99", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "09e0993212584334b177024040b42964", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "67fe516fb3554ba988afe638a10e188c", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "2df92561fa1f4dfe96526ae48c929af7", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c1076efc41754184b6e4888c479e9092", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a02239aab451417c9d6ea4c35c116d59", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "23fdbbd58c3b413aaa091965e194e0b9", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "930107dbf2044409a92e2b1522d738b5", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c6f748afd2114c5f9f8b177e1ac9032d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "877e6a5cd0e74d18b73d8572ba851dea", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4ef70ac799bc4bf894b9e3827852e78d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "21b5c8f19b8d447abcdf702a48738e25", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0b8bcf94ed5c47578bbde3ed4323dab8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "f24bbb19d4214cefac6fbff91fc347ef", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "928f3e9c758945af9c0d4462c072603d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b4618db1c8fc47dc8ad2ab889f002a06", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "aafb22b7156341958d1695ec9f0718a0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "9958436a4f244c13af9a2499ab428f4b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6b7081fd42944f72ae31ded08765633d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3f3df0ea9ca147cba8c7c9bf4d275908", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8ec85158099d4879a7470b2250827cc8", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8aae5039005845d4901ae890cf17454e", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "937097c4bdc34fbb8101081b6ce03aa6", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3d38e38ec56b4208a352c20435446e3d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "d3beea952aad42b598ef1c0f08b18281", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c5ae881c597a422fa430d4086dd5c2ce", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "616b6c79101949babc2ae121d5d326b1", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e8553be9add44a36af106f06fb179291", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "0bf0aaf1aa534beea101c77681e4dd78", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "18003752d46449db8efa334c5057b25b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "420d14d8d51e4f0ba932dfa7328d6d44", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "052ce97803c24167a244d130d3f95b30", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "18fbeec85b324845bd11c0f5a3e5563b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "e19a3311a616441abb150a5ffb14992d", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "4a711e22dc7e445faf045ffe5aec0366", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "b827371db1ec4c1b865cc3420526a0fc", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "c5e5cea2625a472eb1f23e371c77d369", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "a6412551881247838ee4ee2cefe2eb62", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3bccc2e180cc4e2093aad79188362c60", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3945160bf0c74544bf84c00a35c09bd0", "version_major": 2, "version_minor": 0}
</script></div>
</div>
</div>
<div class="section" id="minres-results-illustration">
<h2>MINRES results illustration<a class="headerlink" href="#minres-results-illustration" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">,</span> <span class="n">proj_type</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">))</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;autumn&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>

<span class="n">total_top1s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
    <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">sgd_path</span> <span class="o">/</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
    <span class="n">losses</span><span class="p">,</span> <span class="n">top1s</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
    <span class="n">total_top1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top1s</span><span class="p">)</span>
<span class="n">total_top1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">total_top1s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">top1s_min</span> <span class="o">=</span> <span class="n">total_top1s</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.99</span>
<span class="n">total_err1s</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">total_top1s</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">total_err1s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">))],</span>
           <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evenly_dist</span><span class="p">(</span><span class="n">num_weights</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
    <span class="n">total_top1s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
            <span class="n">ckpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mr_path</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">/</span>  <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">.pth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="n">map_location</span><span class="o">=</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
            <span class="n">losses</span><span class="p">,</span> <span class="n">top1s</span> <span class="o">=</span> <span class="n">ckpt</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">top1s</span> <span class="o">&lt;</span> <span class="n">top1s_min</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">total_top1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top1s</span><span class="p">)</span>
    <span class="n">total_err1s</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">total_top1s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">total_err1s</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Task 1 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Task 2 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Task 3 Top-1 Error&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="nb">tuple</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]))</span>
<span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Start&#39;</span><span class="p">)</span>

<span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
    <span class="nb">tuple</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">]))</span>
<span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Ours&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">handler_map</span><span class="o">=</span><span class="p">{</span><span class="nb">tuple</span><span class="p">:</span> <span class="n">HandlerTuple</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">45</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census_59_0.png" src="_images/T277640_Efficient_Continuous_Pareto_Exploration_in_MTL_on_UCI_Census_59_0.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sparsh-ai/multiobjective-optimizations",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="T423887_Solving_MOO_with_SMT_Toolkit.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Solving MOO with SMT Toolkit</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="T851476_Multi_Task_Learning.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Multi-Task Learning</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Sparsh A.<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>